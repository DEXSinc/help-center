<link rel="import" href="../lib/polymer/polymer.html">
<link rel="import" href="../lib/polymer-redux/polymer-redux.html" >

<script>
    const initialState = {
        friends: [],
        stripePublishableKey: 'pk_test_4yXPdlu4RWjHnY5U6xobOc6x',
        loading: false,
        username: null,
        routeData: {},
        page: {
            name: 'home',
            title: 'Home'
        },
        pageTitles: {
            'home': 'Home',
            'dynamo': 'Google Shopping Launcher',
            'dynamo-dashboard': 'Dashboard',
            'faqs': 'Frequently Asked Questions',
            'videos': 'Video Library',
            'articles': 'Knowledge Articles'
        },
        selectedPackage: null,
        selectedPackageDetails: {},
        selectedPlan: null,
        selectedPackagePlans: [],
        selectedPackagePlanCount: 0,
        dynamoPackages: [
            {
                id: 'online',
                name: 'eCommerce',
                icons: ['icons:shopping-cart'],
                description: 'Bring more qualified buyers to your eCommerce store',
                defaultPlan: 2
            },{
                id: 'retail',
                name: 'Retail',
                icons: ['icons:store'],
                description: 'Drive more consumer foot traffic to your store',
                defaultPlan: 2
            },{
                id: 'both',
                name: 'Both',
                icons: ['icons:shopping-cart','icons:store'],
                description: 'Best option to maximize your product visibility',
                defaultPlan: 1
            }
        ],
        dynamoPlans: [
            {
                id: 'online',
                plans: [{
                        id: 1,
                        name: 'Starter',
                        cost: 199,
                        frequency: 'mo',
                        description: 'All the basics for a small store that is new to online advertising'
                    }, {
                        id: 2,
                        name: 'Standard',
                        cost: 499,
                        frequency: 'mo',
                        description: 'Everything you need to stay competitive and relevant on Google Search'
                    }, {
                        id: 3,
                        name: 'Advanced',
                        cost: 899,
                        frequency: 'mo',
                        description: 'Advanced machine learning and optimization to help you scale'
                    }, {
                        id: 4,
                        name: 'Custom',
                        cost: 0,
                        frequency: null,
                        description: 'Adjust the spend as per your needs and the machine learning technology will maximize performance'
                    }
                ]
            }, {
                id: 'retail',
                plans: [{
                        id: 1,
                        name: 'Starter',
                        cost: 199,
                        frequency: 'mo',
                        description: 'All the basics for a small store that is new to online advertising'
                    }, {
                        id: 2,
                        name: 'Standard',
                        cost: 499,
                        frequency: 'mo',
                        description: 'Everything you need to stay competitive and relevant on Google Search'
                    }, {
                        id: 3,
                        name: 'Advanced',
                        cost: 899,
                        frequency: 'mo',
                        description: 'Advanced machine learning and optimization to help you scale'
                    }, {
                        id: 4,
                        name: 'Custom',
                        cost: 0,
                        frequency: null,
                        description: 'Adjust the spend as per your needs and the machine learning technology will maximize performance'
                    }
                ]
            }, {
                id: 'both',
                plans: [
                    {
                        id: 1,
                        name: 'Standard',
                        cost: 699,
                        frequency: 'mo',
                        description: 'Everything you need to stay competitive and relevant on Google Search'
                    }, {
                        id: 2,
                        name: 'Advanced',
                        cost: 1099,
                        frequency: 'mo',
                        description: 'Advanced machine learning and optimization to help you scale'
                    }, {
                        id: 3,
                        name: 'Custom',
                        cost: 0,
                        frequency: null,
                        description: 'Adjust the spend as per your needs and the machine learning technology will maximize performance'
                    }
                ]
            }
        ],
        dynamo: {
            graphs: {
                summary: []
            },
            inventory: [],
            seriesData: {}
        }
    };

    const reducer = (state, action) => {
        if (!state) return initialState;
        switch (action.type) {
            case 'PACKAGE_SELECTED': {
                let selectedPackagePlans = state.dynamoPlans.find(function(ee) {
                    return ee.id == action.id;
                }).plans || [];
                let selectedPackageDetails = state.dynamoPackages.find(function(ee) {
                    return ee.id == action.id;
                }) || null;
                return Object.assign({}, state, { selectedPackagePlanCount: selectedPackagePlans.length, selectedPackage: action.id, selectedPackagePlans: selectedPackagePlans, selectedPackageDetails: selectedPackageDetails });
            }
            case 'PLAN_SELECTED': {
                let selectedPlan = state.selectedPackagePlans.find(function(ee) {
                    return ee.id == action.id;
                }) || null;
                return Object.assign({}, state, { selectedPlan: selectedPlan });
            }
            case 'ADD_FRIEND':  {
                const friends = state.friends.slice(0);
                friends.push(action.friend);
                return Object.assign({}, state, { friends: friends });
            }
            case 'SIGN_UP_STARTED': {
                return Object.assign({}, state, { loading: true });
            }
            case 'SIGN_UP_COMPLETED': {
                return Object.assign({}, state, { loading: false, username: action.username });
            }
            case 'ROUTE_CHANGED': {
                var pageTitle = state.pageTitles[action.data.page] || state.pageTitles['home'];
                return Object.assign({}, state, { routeData: action.data, page: { title: pageTitle, name: action.data.page } });
            }
            case 'DYNAMO_DATA_CHANGED': {
                var newData = action.data;
                var dynamo = state.dynamo;
                dynamo.graphs[action.path] = newData;
                return Object.assign({}, state, { dynamo: dynamo });
            }
            case 'DYNAMO_SERIES_DATA_CHANGED': {
                var dynamo = Object.assign({}, state.dynamo);
                dynamo.seriesData = action.data;
                return Object.assign({}, state, { dynamo: dynamo });
            }
            case 'DYNAMO_INVENTORY_CHANGED': {
                var newData = action.inventory;
                var dynamo = Object.assign({}, state.dynamo);
                dynamo.inventory = newData;
                return Object.assign({}, state, { dynamo: dynamo });
            }
            default: 
                return state;
        }
    };

    const store = Redux.createStore(
        reducer,
        Redux.applyMiddleware(ReduxThunk.default)
    );

    /**
     * @polymerBehavior ReduxBehavior
     */
    const ReduxBehavior = PolymerRedux(store);

    const getData = function(path, params, callback) {
        var ajax = new XMLHttpRequest();
        ajax.open("GET", path, true);
        ajax.send();
        ajax.onreadystatechange = function() {
            if (ajax.readyState == 4 && ajax.status == 200) {
                var data = JSON.parse(ajax.responseText);
                callback(data);
            }
        }
    }

    /**
     * @polymerBehavior AsyncActionsBehavior
     */
    const AsyncActionsBehavior = {
        actions: {
            signUpWithTimeout: function(username) {
                return function(dispatch) {
                    dispatch({type: 'SIGN_UP_STARTED'});
                    setTimeout(function() {
                        dispatch({ type: 'SIGN_UP_COMPLETED', username: username });
                    }, 3000);
                }
            },
            getDynamoData: function(path) {
                return function(dispatch) {
                    var callback = function(data) {
                        // console.log(data);
                        dispatch({ type: 'DYNAMO_DATA_CHANGED', path: path, data: data });
                    }
                    var callback2 = function(data) {
                        // console.log(data);
                        dispatch({ type: 'DYNAMO_INVENTORY_CHANGED', inventory: data })
                    }
                    var callback3 = function(data) {
                        // console.log(data);
                        dispatch({ type: 'DYNAMO_SERIES_DATA_CHANGED', data: data })
                    }
                    getData('data/dynamo/data0.json', null, callback);
                    getData('data/dynamo/inventory0.json', null, callback2);
                    getData('data/dynamo/data1.json', null, callback3);
                }
            }
        }
    };
</script>